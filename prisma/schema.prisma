// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(cuid())
  username      String?   @unique
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  password      String?
  role          String    @default("user") // user, expert, influencer

  // Steam 연동
  steamId       String?   @unique
  steamUsername String?

  // 개인정보 설정
  profileVisibility String @default("public") // public, private
  reviewVisibility  String @default("public") // public, followers, private

  // 프로필 정보
  bio               String? // 한 줄 소개
  preferredPlatform String? // PC, PlayStation, Nintendo, Xbox, Mobile

  reviews          Review[]
  lists            GameList[]
  likes            ReviewLike[]
  followers        Follow[]           @relation("Follower")
  following        Follow[]           @relation("Following")
  developer        Developer?
  notifications    Notification[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([username])
  @@index([steamId])
}

// Game model
model Game {
  id              String   @id @default(cuid())
  title           String
  description     String?
  coverImage      String?
  releaseDate     DateTime?
  platforms       String   // JSON string of platform codes
  genres          String   // JSON string of genres
  tags            String?  // JSON string of Steam tags (from Steam Spy)
  developer       String?
  publisher       String?
  igdbId          Int?     @unique  // IGDB API game ID
  metacriticScore Int?     // Metacritic score (0-100)

  // OpenCritic scores
  opencriticId              Int?     // OpenCritic game ID
  opencriticScore           Float?   // OpenCritic score (0-100)
  opencriticPercentRecommended Float? // Percent recommended (0-100)
  opencriticTier            String?  // Mighty, Strong, Fair, Weak

  // Aggregated statistics
  averageRating   Float    @default(0)
  totalReviews    Int      @default(0)
  verifiedReviews Int      @default(0)

  // Steam 인기도 (배치 작업으로 업데이트)
  hotScore        Float    @default(0)  // Steam Top Sellers/Most Played 기반 인기 점수
  hotScoreUpdatedAt DateTime?           // 마지막 업데이트 시간
  currentPlayers  Int      @default(0)  // Steam 동시 접속자 수
  playersUpdatedAt DateTime?            // 동시 접속자 수 업데이트 시간

  reviews         Review[]
  listItems       ListItem[]
  announcements   Announcement[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([title])
  @@index([averageRating])
  @@index([releaseDate])
  @@index([hotScore])
  @@index([currentPlayers])
}

// Review model
model Review {
  id                 String   @id @default(cuid())
  gameId             String
  userId             String
  rating             Float    // 0.5 to 5.0
  comment            String?
  label              String   // 매우 긍정적, 긍정적, 혼합, 부정적, 매우 부정적

  // Verification
  isVerified         Boolean  @default(false)
  verificationType   String?  // STEAM, PLAYSTATION, XBOX, SCREENSHOT
  verificationProof  String?  // URL or file path

  // Element ratings (optional)
  priceRating        Float?   // 가격 만족도
  graphicsRating     Float?   // 그래픽
  controlRating      Float?   // 조작감
  directionRating    Float?   // 연출
  storyRating        Float?   // 스토리
  soundRating        Float?   // OST
  volumeRating       Float?   // 컨텐츠 볼륨
  innovationRating   Float?   // 혁신성과 독창성

  // Social
  likesCount         Int      @default(0)

  game               Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes              ReviewLike[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([gameId, userId]) // One review per user per game
  @@index([gameId])
  @@index([userId])
  @@index([createdAt])
  @@index([rating])
}

// Review likes
model ReviewLike {
  id        String   @id @default(cuid())
  reviewId  String
  userId    String
  type      String   @default("like") // "like" or "dislike"

  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
}

// Game lists
model GameList {
  id          String     @id @default(cuid())
  userId      String
  name        String
  type        String     // PLAYING, PLAN_TO_PLAY, COMPLETED, TOP10, YEAR_BEST, CUSTOM
  description String?
  isPublic    Boolean    @default(true)

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       ListItem[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
  @@index([type])
}

// List items
model ListItem {
  id        String   @id @default(cuid())
  listId    String
  gameId    String
  order     Int      @default(0)

  list      GameList @relation(fields: [listId], references: [id], onDelete: Cascade)
  game      Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([listId, gameId])
  @@index([listId])
  @@index([gameId])
}

// Follow system
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String

  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Developer accounts
model Developer {
  id           String         @id @default(cuid())
  userId       String         @unique
  companyName  String
  isVerified   Boolean        @default(false)

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  announcements Announcement[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([userId])
}

// Developer announcements
model Announcement {
  id          String    @id @default(cuid())
  gameId      String
  developerId String
  title       String
  content     String
  type        String    // ANNOUNCEMENT, PATCH_NOTE, RESPONSE
  isPinned    Boolean   @default(false)

  game        Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  developer   Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([gameId])
  @@index([developerId])
  @@index([createdAt])
}

// Pending users (before email verification)
model PendingUser {
  id         String   @id @default(cuid())
  username   String   @unique
  email      String   @unique
  password   String   // Hashed password
  name       String

  createdAt  DateTime @default(now())
  expiresAt  DateTime // Auto-delete after 24 hours if not verified

  @@index([email])
  @@index([username])
  @@index([expiresAt])
}

// Email verification tokens
model VerificationToken {
  id         String   @id @default(cuid())
  email      String
  token      String   @unique
  expires    DateTime

  createdAt  DateTime @default(now())

  @@unique([email, token])
  @@index([email])
  @@index([token])
}

// Deleted emails (for preventing re-registration)
model DeletedEmail {
  id        String   @id @default(cuid())
  email     String   @unique
  deletedAt DateTime @default(now())

  @@index([email])
}

// Notifications
model Notification {
  id          String   @id @default(cuid())
  userId      String   // 알림을 받는 사용자
  type        String   // FOLLOW, REVIEW, LIKE, etc.
  message     String   // 알림 메시지
  actorId     String?  // 알림을 발생시킨 사용자
  gameId      String?  // 관련 게임 (있을 경우)
  reviewId    String?  // 관련 리뷰 (있을 경우)
  isRead      Boolean  @default(false)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

