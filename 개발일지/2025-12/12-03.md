# 개발일지 - 2025년 12월 3일

## 완료한 작업

### 1. 회원가입 후 온보딩 자동 리다이렉트

**변경 내용:**
- 이메일 인증 완료 후 온보딩 안내 메시지 추가
- 로그인 시 신규 사용자 자동으로 `/onboarding`으로 리다이렉트
- Google OAuth 로그인 시 온보딩 자동 리다이렉트

**수정 파일:**
- `src/app/verify-email/page.tsx` - 인증 성공 메시지에 온보딩 안내 추가
- `src/app/login/page.tsx` - 로그인 시 `needsOnboarding` 체크 후 리다이렉트
- `src/app/signup/page.tsx` - Google OAuth 회원가입 시 온보딩 체크

**커밋:** 72ce28d - Add automatic onboarding redirect after signup

### 2. 인증 코드 재전송 에러 처리 개선

**문제:**
- 재전송 버튼 클릭 시 이메일 발송 실패하면 전체 API가 에러 반환

**해결:**
- 이메일 발송 실패해도 계속 진행하도록 try-catch 추가
- 회원가입 API와 동일한 에러 처리 패턴 적용

**수정 파일:**
- `src/app/api/auth/resend-code/route.ts`

**커밋:** da37fd8 - Fix resend verification code error handling

### 3. 이메일 인증 전 계정 생성 방지

**기존 문제:**
- 회원가입 시 바로 User 테이블에 저장 (emailVerified: null)
- 인증하지 않아도 DB에 계정이 남음

**해결 방법:**
- PendingUser 모델 추가 (임시 저장)
- 회원가입 → PendingUser 생성 (User 생성 안 함)
- 이메일 인증 완료 → User 생성, PendingUser 삭제
- 24시간 후 PendingUser 자동 만료

**새로운 Prisma 스키마:**
```prisma
model PendingUser {
  id         String   @id @default(cuid())
  username   String   @unique
  email      String   @unique
  password   String   // Hashed password
  name       String
  createdAt  DateTime @default(now())
  expiresAt  DateTime // 24시간 후 만료
}
```

**수정 파일:**
- `prisma/schema.prisma` - PendingUser 모델 추가
- `src/app/api/auth/signup/route.ts` - PendingUser 생성
- `src/app/api/auth/verify/route.ts` - PendingUser → User 이동
- `src/app/api/auth/resend-code/route.ts` - PendingUser 확인

**DB 마이그레이션:**
- Neon PostgreSQL에 PendingUser 테이블 추가 완료

**커밋:** 241fd1b - Prevent account creation before email verification

### 4. 미인증 이메일 재가입 허용

**문제:**
- 인증하지 않은 이메일로 다시 회원가입 시도 시 "이미 가입된 이메일입니다" 에러
- 실제로는 User 계정이 없는데 가입 불가

**해결:**
- 같은 이메일로 재가입 시 기존 PendingUser 삭제 후 새로 생성
- 새로운 인증 코드 발급
- 인증된 계정(User)만 중복 체크

**수정 파일:**
- `src/app/api/auth/signup/route.ts`

**커밋:** b177ded - Allow re-registration for unverified emails

### 5. 메모.txt 개발 규칙 업데이트

**추가된 규칙:**
```
테스트 환경:
- 기능 추가 및 테스트는 프로덕션 환경(https://www.gampfire.com)에서 진행
- 로컬 개발 서버는 긴급 디버깅 시에만 사용
- 모든 변경사항은 Git 커밋 후 자동 배포되므로 프로덕션에서 확인
```

## 현재 알려진 문제

### 🔴 이메일 발송 실패

**문제:**
- 회원가입/재전송 시 이메일이 발송되지 않음
- SMTP 연결 실패

**원인:**
- Vercel 환경 변수에 줄바꿈 문자(`\n`) 포함
- `EMAIL_HOST="smtp.gmail.com\n"`
- `EMAIL_PORT="587\n"`
- `EMAIL_USER="gampfireofical@gmail.com\n"`
- `EMAIL_PASSWORD="uqzu uyho lluk pqta\n"`
- `NEXTAUTH_URL="ttps://www.gampfire.com"` (h 빠짐)

**임시 해결책:**
- DB에서 직접 인증 코드 조회 (check-code.js 스크립트)
- 사용자에게 코드 전달

**근본 해결 필요:**
- Vercel 대시보드에서 환경 변수 수정
- 모든 환경(Production, Preview, Development)의 변수 끝 줄바꿈 제거
- NEXTAUTH_URL에 https 추가

## 작동 플로우 (수정 후)

### 이메일 회원가입
1. 회원가입 → PendingUser 테이블에 저장
2. 이메일 인증 코드 발송 (현재 실패 - 환경 변수 문제)
3. 인증 코드 입력 → User 테이블에 계정 생성, PendingUser 삭제
4. 로그인 → 자동으로 온보딩(`/onboarding`)으로 이동
5. 10개 게임 평가 → 메인 페이지

### Google OAuth 회원가입/로그인
1. "Google로 계속하기" 클릭
2. Google 인증 완료
3. 신규 사용자 → 자동으로 온보딩 페이지로 이동
4. 기존 사용자 → 메인 페이지로 이동

## Git 커밋 내역

```
b177ded - Allow re-registration for unverified emails
241fd1b - Prevent account creation before email verification
da37fd8 - Fix resend verification code error handling
72ce28d - Add automatic onboarding redirect after signup
```

## 다음 작업 계획

- [ ] **긴급: Vercel 환경 변수 수정 (이메일 발송 복구)**
- [ ] 알림 시스템 실시간 업데이트 (WebSocket 또는 polling)
- [ ] 게임 리스트 기능 (찜, 플레이 중, 완료)

## 기술 스택

- **인증:** NextAuth.js, PendingUser 시스템
- **데이터베이스:** Neon PostgreSQL, Prisma ORM
- **이메일:** nodemailer, Gmail SMTP (현재 환경 변수 문제로 미작동)
- **배포:** Vercel

## 배포 정보

- **Production URL:** https://www.gampfire.com
- **최신 커밋:** b177ded - Allow re-registration for unverified emails
- **배포 상태:** ✅ 성공
- **알려진 이슈:** 이메일 발송 실패 (환경 변수 수정 필요)

## 참고사항

- PendingUser는 24시간 후 자동 만료
- 미인증 이메일로 재가입 가능
- 인증 코드는 DB에서 직접 조회 가능 (임시)
- 이메일 환경 변수 수정 후 재배포 필요
